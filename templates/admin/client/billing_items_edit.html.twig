{% extends 'admin/client/client.html.twig' %}

{% block client %}
    {% include 'admin/client/show/client_api.html.twig' %}
    {% include 'admin/client/edit/billing_items.html.twig' %}
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script>
        (function (){
            const calc = function () {
                document.querySelector('[data-content="net-value"]').innerHTML = '';
                document.querySelector('[data-content="vat-value"]').innerHTML = '';
                document.querySelector('[data-content="gross-value"]').innerHTML = '';

                let netValue = 0;
                let vatValue = 0;

                document.querySelectorAll('div[data-content="billing-items"] div[data-content="billing-item"]').forEach((tr) => {
                    const quantity = parseInt(tr.querySelector('input[data-content="quantity"]').value)
                    const unitPrice = parseFloat(tr.querySelector('input[data-content="unit-price"]').value.replace(',','.'))

                    if (quantity > 0 && unitPrice > 0) {
                        const quantity = parseInt(tr.querySelector('input[data-content="quantity"]').value)

                        netValue += unitPrice * quantity;

                        const vatRate = parseInt(tr.querySelector('select[data-content="vat-rate"]').value)
                        if (vatRate > 0) {
                            vatValue += unitPrice * quantity  * vatRate/100;
                        }
                    }
                });

                document.querySelector('[data-content="net-value"]').innerHTML = new Intl.NumberFormat('PL-pl').format(netValue.toFixed(2)) + ' PLN';
                document.querySelector('[data-content="vat-value"]').innerHTML =new Intl.NumberFormat('PL-pl').format(vatValue.toFixed(2)) + ' PLN';
                document.querySelector('[data-content="gross-value"]').innerHTML = new Intl.NumberFormat('PL-pl').format((netValue + vatValue).toFixed(2)) + ' PLN';
            };

            calc();

            const table = document.querySelector('div[data-content="billing-items"]');
            table.addEventListener('input', function (event) {
                calc();
            })

            const add = document.querySelector('button[name="add-billing-item"]');
            add.addEventListener('click', function (event) {
                event.preventDefault();

                const collectionHolder = document.querySelector('div[data-content="billing-items"]');
                const item = document.createElement('div');

                item.innerHTML = collectionHolder
                    .dataset
                    .prototype
                    .replace(
                        /__name__/g,
                        collectionHolder.dataset.index
                    )
                    .replace(
                        /__number__/g,
                        parseInt(collectionHolder.dataset.index) + 1
                    );
                collectionHolder.appendChild(item.firstElementChild);
                collectionHolder.dataset.index++;
            })
        }());
    </script>
{% endblock %}